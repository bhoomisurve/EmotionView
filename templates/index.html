<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>EmotionView Interview System</title>
	<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
	<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
	<style>
    	.emotion-badge {
        	transition: all 0.3s ease;
    	}
    	.emotion-badge.active {
        	transform: scale(1.1);
        	box-shadow: 0 0 15px rgba(59, 130, 246, 0.7);
    	}
    	.video-container {
        	position: relative;
        	overflow: hidden;
        	border-radius: 0.5rem;
        	box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
    	}
    	.emotion-timeline {
        	height: 30px;
        	transition: width 0.3s ease;
    	}
    	@keyframes pulse {
        	0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); }
        	70% { box-shadow: 0 0 0 10px rgba(255, 0, 0, 0); }
        	100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); }
    	}
    	.recording-indicator {
        	animation: pulse 2s infinite;
    	}
    	.btn-primary {
        	transition: all 0.3s ease;
    	}
    	.btn-primary:hover {
        	transform: translateY(-2px);
        	box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    	}
    	.btn-primary:active {
        	transform: translateY(0);
    	}
    	.progress-stepper {
        	display: flex;
        	justify-content: space-between;
        	margin-top: 1rem;
        	position: relative;
    	}
    	.progress-stepper::before {
        	content: '';
        	position: absolute;
        	top: 50%;
        	left: 0;
        	right: 0;
        	height: 2px;
        	background: #e2e8f0;
        	transform: translateY(-50%);
        	z-index: 1;
    	}
    	.step {
        	width: 30px;
        	height: 30px;
        	border-radius: 50%;
        	background: #e2e8f0;
        	display: flex;
        	align-items: center;
        	justify-content: center;
        	font-weight: bold;
        	z-index: 2;
        	position: relative;
        	transition: all 0.3s ease;
    	}
    	.step.active {
        	background: #3b82f6;
        	color: white;
    	}
    	.step.completed {
        	background: #10b981;
        	color: white;
    	}
    	.tooltip {
        	position: relative;
    	}
    	.tooltip:hover .tooltip-text {
        	visibility: visible;
        	opacity: 1;
    	}
    	.tooltip-text {
        	visibility: hidden;
        	width: 120px;
        	background-color: #333;
        	color: #fff;
        	text-align: center;
        	border-radius: 6px;
        	padding: 5px;
        	position: absolute;
        	z-index: 1;
        	bottom: 125%;
        	left: 50%;
        	margin-left: -60px;
        	opacity: 0;
        	transition: opacity 0.3s;
    	}
    	.tooltip-text::after {
        	content: "";
        	position: absolute;
        	top: 100%;
        	left: 50%;
        	margin-left: -5px;
        	border-width: 5px;
        	border-style: solid;
        	border-color: #333 transparent transparent transparent;
    	}
    	/* Custom scrollbar */
    	::-webkit-scrollbar {
        	width: 8px;
        	height: 8px;
    	}
    	::-webkit-scrollbar-track {
        	background: #f1f1f1;
        	border-radius: 10px;
    	}
    	::-webkit-scrollbar-thumb {
        	background: #3b82f6;
        	border-radius: 10px;
    	}
    	::-webkit-scrollbar-thumb:hover {
        	background: #2563eb;
    	}
    	/* Added animation for smoother transitions */
    	.fade-in {
        	animation: fadeIn 0.5s ease-in-out;
    	}
    	@keyframes fadeIn {
        	from { opacity: 0; }
        	to { opacity: 1; }
    	}
	</style>
</head>
<body class="bg-gray-100 h-screen">
	<div class="flex flex-col h-full">
    	<!-- Header -->
    	<header class="bg-blue-900 text-white shadow-lg">
        	<div class="container mx-auto px-4 py-3 flex justify-between items-center">
            	<div class="flex items-center space-x-3">
                	<div class="flex items-center">
                    	<i class="fas fa-brain text-2xl text-blue-300"></i>
                    	<div class="ml-2">
                        	<h1 class="text-xl font-bold">EmotionView</h1>
                        	<p class="text-xs text-blue-300">AI-Powered Interview Analysis</p>
                    	</div>
                	</div>
            	</div>
            	<div class="flex items-center space-x-4">
                	<span id="status-indicator" class="px-3 py-1 rounded-full bg-yellow-500 text-xs font-bold flex items-center">
                    	<i class="fas fa-circle text-xs mr-1"></i>
                    	<span>READY</span>
                	</span>
                	<div class="tooltip">
                    	<button id="settings-btn" class="p-2 rounded-full hover:bg-blue-800 transition">
                        	<i class="fas fa-cog"></i>
                    	</button>
                    	<span class="tooltip-text">Settings</span>
                	</div>
                	<div class="tooltip">
                    	<a href="/dashboard" class="p-2 rounded-full hover:bg-blue-800 transition">
                        	<i class="fas fa-th-large"></i>
                    	</a>
                    	<span class="tooltip-text">Dashboard</span>
                	</div>
            	</div>
        	</div>
    	</header>

    	<!-- Main Content -->
    	<div class="flex-1 container mx-auto px-4 py-6 flex flex-col lg:flex-row gap-6 overflow-hidden">
        	<!-- Left Panel: Video Feed -->
        	<div class="w-full lg:w-3/5 flex flex-col space-y-4">
            	<div class="bg-white rounded-lg shadow-lg p-4 flex-1">
                	<div class="flex justify-between items-center mb-4">
                    	<h2 class="text-lg font-bold text-gray-700 flex items-center">
                        	<i class="fas fa-video text-blue-500 mr-2"></i>
                        	Video Feed
                    	</h2>
                    	<div class="flex items-center">
                        	<div class="recording-indicator bg-red-500 rounded-full h-3 w-3 mr-2" id="rec-indicator"></div>
                        	<span class="text-xs text-gray-500 hidden md:inline" id="recording-status">Ready</span>
                    	</div>
                	</div>
                	<div class="video-container bg-gray-900 rounded-lg h-96 flex items-center justify-center relative">
                    	<img id="video_feed" src="/video_feed" alt="Video Feed" class="h-full w-full object-contain">
                    	<div id="overlay-message" class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-70 text-white text-xl font-bold hidden">
                        	<div class="text-center">
                            	<i class="fas fa-pause-circle text-5xl mb-3"></i>
                            	<p>Interview Paused</p>
                        	</div>
                    	</div>
                	</div>
               	 
                	<!-- Emotion Timeline -->
                	<div class="mt-6">
                    	<div class="flex justify-between items-center mb-2">
                        	<h3 class="text-sm font-semibold text-gray-600">Emotion Timeline</h3>
                        	<div class="text-xs text-gray-500" id="timeline-duration">00:00</div>
                    	</div>
                    	<div class="flex h-8 w-full bg-gray-200 rounded-md overflow-hidden" id="emotion-timeline">
                        	<!-- Timeline segments will be added dynamically -->
                    	</div>
                    	<div class="flex justify-between text-xs text-gray-500 mt-1">
                        	<span>Start</span>
                        	<span>Current</span>
                    	</div>
                	</div>
            	</div>
           	 
            	<!-- Emotion Analysis -->
            	<div class="bg-white rounded-lg shadow-lg p-4">
                	<div class="flex justify-between items-center mb-3">
                    	<h2 class="text-lg font-bold text-gray-700 flex items-center">
                        	<i class="fas fa-heartbeat text-red-500 mr-2"></i>
                        	Current Emotion
                    	</h2>
                    	<div class="text-xs text-blue-600 font-medium cursor-pointer hover:underline" id="view-emotion-details">
                        	View Details
                    	</div>
                	</div>
                	<div class="flex justify-around">
                    	<div class="emotion-badge p-3 rounded-lg text-center w-20 md:w-24" id="emotion-happy" data-emotion="Happy">
                        	<i class="far fa-smile text-2xl text-yellow-500"></i>
                        	<p class="text-sm mt-1">Happy</p>
                        	<div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                            	<div class="bg-yellow-500 h-2 rounded-full" style="width: 0%"></div>
                        	</div>
                    	</div>
                    	<div class="emotion-badge p-3 rounded-lg text-center w-20 md:w-24" id="emotion-sad" data-emotion="Sad">
                        	<i class="far fa-frown text-2xl text-blue-500"></i>
                        	<p class="text-sm mt-1">Sad</p>
                        	<div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                            	<div class="bg-blue-500 h-2 rounded-full" style="width: 0%"></div>
                        	</div>
                    	</div>
                    	<div class="emotion-badge p-3 rounded-lg text-center w-20 md:w-24" id="emotion-angry" data-emotion="Angry">
                        	<i class="far fa-angry text-2xl text-red-500"></i>
                        	<p class="text-sm mt-1">Angry</p>
                        	<div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                            	<div class="bg-red-500 h-2 rounded-full" style="width: 0%"></div>
                        	</div>
                    	</div>
                    	<div class="emotion-badge p-3 rounded-lg text-center w-20 md:w-24" id="emotion-surprise" data-emotion="Surprise">
                        	<i class="far fa-surprise text-2xl text-purple-500"></i>
                        	<p class="text-sm mt-1">Surprise</p>
                        	<div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                            	<div class="bg-purple-500 h-2 rounded-full" style="width: 0%"></div>
                        	</div>
                    	</div>
                    	<div class="emotion-badge p-3 rounded-lg text-center w-20 md:w-24" id="emotion-neutral" data-emotion="Neutral">
                        	<i class="far fa-meh text-2xl text-gray-500"></i>
                        	<p class="text-sm mt-1">Neutral</p>
                        	<div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                            	<div class="bg-gray-500 h-2 rounded-full" style="width: 0%"></div>
                        	</div>
                    	</div>
                	</div>
            	</div>
        	</div>

        	<!-- Right Panel: Interview Controls -->
        	<div class="w-full lg:w-2/5 flex flex-col space-y-4">
            	<!-- Candidate Info -->
            	<div class="bg-white rounded-lg shadow-lg p-4">
                	<div class="flex justify-between items-center mb-3">
                    	<h2 class="text-lg font-bold text-gray-700 flex items-center">
                        	<i class="fas fa-user text-blue-500 mr-2"></i>
                        	Candidate Information
                    	</h2>
                    	<button id="load-candidate-btn" class="text-xs text-blue-600 hover:underline flex items-center">
                        	<i class="fas fa-user-check mr-1"></i> Load Previous
                    	</button>
                	</div>
                	<div class="grid grid-cols-2 gap-4">
                    	<div class="space-y-2">
                        	<label class="block text-sm font-medium text-gray-700">Name</label>
                        	<div class="relative">
                            	<div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                	<i class="fas fa-user text-gray-400"></i>
                            	</div>
                            	<input type="text" id="candidate-name" class="w-full pl-10 p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="John Smith">
                        	</div>
                    	</div>
                    	<div class="space-y-2">
                        	<label class="block text-sm font-medium text-gray-700">Email</label>
                        	<div class="relative">
                            	<div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                	<i class="fas fa-envelope text-gray-400"></i>
                            	</div>
                            	<input type="email" id="candidate-email" class="w-full pl-10 p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="john@example.com">
                        	</div>
                    	</div>
                    	<div class="space-y-2 col-span-2">
                        	<label class="block text-sm font-medium text-gray-700">Position</label>
                        	<div class="relative">
                            	<div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                	<i class="fas fa-briefcase text-gray-400"></i>
                            	</div>
                            	<select id="candidate-position" class="w-full pl-10 p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                	<option value="general">General</option>
                                	<option value="software_engineer">Software Engineer</option>
                                	<option value="data_scientist">Data Scientist</option>
                                	<option value="marketing">Marketing</option>
                                	
                            	</select>
                        	</div>
                    	</div>
                	</div>
            	</div>

            	<!-- Question Section -->
            	<div class="bg-white rounded-lg shadow-lg p-4 flex-1">
                	<div class="flex justify-between items-center mb-3">
                    	<h2 class="text-lg font-bold text-gray-700 flex items-center">
                        	<i class="fas fa-question-circle text-blue-500 mr-2"></i>
                        	Interview Questions
                    	</h2>
                    	<div class="flex items-center">
                        	<div class="text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded-md flex items-center">
                            	<span id="question-counter" class="font-semibold">1</span>
                            	<span class="mx-1">/</span>
                            	<span>10</span>
                        	</div>
                    	</div>
                	</div>
               	 
                	<!-- Progress bar for questions -->
                	<div class="w-full bg-gray-200 rounded-full h-2 mb-3">
                    	<div id="question-progress" class="bg-blue-600 h-2 rounded-full" style="width: 10%"></div>
                	</div>
               	 
                	<div class="bg-blue-50 p-4 rounded-md mb-4 border-l-4 border-blue-500">
                    	<p id="current-question" class="text-blue-800 font-medium">Press Start Interview to begin</p>
                	</div>
               	 
                	<div class="space-y-3 mb-4">
                    	<label class="block text-sm font-medium text-gray-700 flex items-center">
                        	<i class="fas fa-comment-alt text-gray-500 mr-2"></i>
                        	Candidate's Answer
                    	</label>
                    	<textarea id="answer-input" rows="5" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Record candidate's response here..."></textarea>
                	</div>
               	 
                	<div class="flex justify-between items-center">
                    	<div>
                        	<label class="inline-flex items-center">
                            	<input type="checkbox" id="use-ai" class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                            	<span class="ml-2 text-sm text-gray-700">Use AI for next question</span>
                        	</label>
                        	<div class="tooltip ml-1">
                            	<i class="fas fa-info-circle text-gray-400"></i>
                            	<span class="tooltip-text">AI will generate questions based on candidate emotions</span>
                        	</div>
                    	</div>
                    	<div class="space-x-2">
                        	<button id="save-answer-btn" class="btn-primary px-3 py-1 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition disabled:opacity-50 flex items-center" disabled>
                            	<i class="fas fa-save mr-1"></i>
                            	Save
                        	</button>
                        	<button id="next-question-btn" class="btn-primary px-3 py-1 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition disabled:opacity-50 flex items-center" disabled>
                            	Next
                            	<i class="fas fa-chevron-right ml-1"></i>
                        	</button>
                    	</div>
                	</div>
            	</div>

            	<!-- Controls -->
            	<div class="bg-white rounded-lg shadow-lg p-4">
                	<div class="flex justify-between items-center">
                    	<div>
                        	<button id="start-interview-btn" class="btn-primary px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition flex items-center">
                            	<i class="fas fa-play mr-2"></i> Start Interview
                        	</button>
                        	<button id="pause-interview-btn" class="btn-primary px-4 py-2 bg-yellow-500 text-white rounded-md hover:bg-yellow-600 transition flex items-center hidden">
                            	<i class="fas fa-pause mr-2"></i> Pause
                        	</button>
                    	</div>
                    	<button id="end-interview-btn" class="btn-primary px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition flex items-center" disabled>
                        	<i class="fas fa-stop mr-2"></i> End Interview
                    	</button>
                	</div>
                	<div class="mt-3 text-xs text-gray-500 text-center">
                    	<p>Pressing End Interview will generate an AI summary of the interview</p>
                	</div>
            	</div>
        	</div>
    	</div>
	</div>

	<!-- Interview Summary Modal -->
	<div id="summary-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    	<div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-screen overflow-y-auto">
        	<div class="p-6">
            	<div class="flex justify-between items-center mb-4 border-b border-gray-200 pb-4">
                	<h2 class="text-2xl font-bold text-gray-800 flex items-center">
                    	<i class="fas fa-file-alt text-blue-500 mr-2"></i>
                    	Interview Summary
                	</h2>
                	<button id="close-modal" class="text-gray-500 hover:text-gray-700">
                    	<i class="fas fa-times text-xl"></i>
                	</button>
            	</div>
           	 
            	<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                	<div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                    	<h3 class="text-lg font-semibold text-gray-700 mb-2 flex items-center">
                        	<i class="fas fa-user-circle text-blue-500 mr-2"></i>
                        	Candidate Information
                    	</h3>
                    	<div id="summary-candidate-info" class="space-y-2 text-gray-700">
                        	<p><span class="font-medium">Name:</span> <span id="summary-name">John Smith</span></p>
                        	<p><span class="font-medium">Position:</span> <span id="summary-position">Software Engineer</span></p>
                        	<p><span class="font-medium">Date:</span> <span id="summary-date">April 23, 2025</span></p>
                    	</div>
                	</div>
               	 
                	<div>
                    	<h3 class="text-lg font-semibold text-gray-700 mb-2 flex items-center">
                        	<i class="fas fa-chart-pie text-blue-500 mr-2"></i>
                        	Emotion Analysis
                    	</h3>
                    	<canvas id="emotion-chart" height="150"></canvas>
                	</div>
            	</div>
           	 
            	<div class="mb-6">
                	<h3 class="text-lg font-semibold text-gray-700 mb-2 flex items-center">
                    	<i class="fas fa-robot text-blue-500 mr-2"></i>
                    	AI Generated Summary
                	</h3>
                	<div id="summary-content" class="bg-gray-50 rounded-md p-4 text-gray-700 border border-gray-200"></div>
            	</div>
           	 
            	<div class="mb-6">
                	<div class="flex items-center justify-between mb-2">
                    	<h3 class="text-lg font-semibold text-gray-700 flex items-center">
                        	<i class="fas fa-list-alt text-blue-500 mr-2"></i>
                        	Interview Questions & Answers
                    	</h3>
                    	<button id="toggle-qa" class="text-xs text-blue-600 hover:underline flex items-center">
                        	<i class="fas fa-chevron-down mr-1"></i> Show All
                    	</button>
                	</div>
                	<div id="qa-content" class="space-y-4 bg-gray-50 rounded-md p-4 border border-gray-200 max-h-60 overflow-y-auto"></div>
            	</div>
           	 
            	<div class="mb-6">
                	<h3 class="text-lg font-semibold text-gray-700 mb-2 flex items-center">
                    	<i class="fas fa-sticky-note text-blue-500 mr-2"></i>
                    	Notes
                	</h3>
                	<textarea id="interview-notes" rows="4" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Add your notes about this interview..."></textarea>
            	</div>
           	 
            	<div class="flex justify-end space-x-3">
                	<button id="save-notes-btn" class="btn-primary px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition flex items-center">
                    	<i class="fas fa-save mr-2"></i>
                    	Save Notes
                	</button>
                	<button id="export-pdf-btn" class="btn-primary px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition flex items-center">
                    	<i class="fas fa-file-pdf mr-2"></i>
                    	Export PDF
                	</button>
            	</div>
        	</div>
    	</div>
	</div>

	<!-- Candidate Selection Modal -->
	<div id="candidate-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    	<div class="bg-white rounded-lg shadow-xl w-full max-w-md">
        	<div class="p-6">
            	<div class="flex justify-between items-center mb-4">
                	<h2 class="text-xl font-bold text-gray-800">Select Previous Candidate</h2>
                	<button id="close-candidate-modal" class="text-gray-500 hover:text-gray-700">
                    	<i class="fas fa-times"></i>
                	</button>
            	</div>
            	<div class="mb-4">
                	<input type="text" id="candidate-search" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Search candidates...">
            	</div>
            	<div id="candidate-list" class="max-h-64 overflow-y-auto border border-gray-200 rounded-md">
                	<!-- Candidates will be loaded here -->
            	</div>
            	<div class="mt-4 flex justify-end">
                	<button id="cancel-candidate-select" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition mr-2">
                    	Cancel
                	</button>
            	</div>
        	</div>
    	</div>
	</div>

	<!-- Emotion Details Modal -->
	<div id="emotion-details-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    	<div class="bg-white rounded-lg shadow-xl w-full max-w-lg">
        	<div class="p-6">
            	<div class="flex justify-between items-center mb-4 border-b border-gray-200 pb-3">
                	<h2 class="text-xl font-bold text-gray-800">Detailed Emotion Analysis</h2>
                	<button id="close-emotion-details" class="text-gray-500 hover:text-gray-700">
                    	<i class="fas fa-times"></i>
                	</button>
            	</div>
            	<div class="mb-4">
                	<canvas id="emotion-history-chart" height="200"></canvas>
            	</div>
            	<div class="mb-4">
                	<h3 class="text-lg font-semibold text-gray-700 mb-2">Current Reading</h3>
                	<div class="grid grid-cols-2 gap-3">
                    	<div class="p-3 bg-gray-50 rounded-md">
                        	<p class="text-sm font-medium text-gray-500">Primary Emotion</p>
                        	<p class="text-lg font-bold" id="detail-primary-emotion">Neutral</p>
                    	</div>
                    	<div class="p-3 bg-gray-50 rounded-md">
                        	<p class="text-sm font-medium text-gray-500">Confidence</p>
                        	<p class="text-lg font-bold" id="detail-confidence">85%</p>
                    	</div>
                	</div>
            	</div>
            	<div>
                	<h3 class="text-lg font-semibold text-gray-700 mb-2">Secondary Emotions</h3>
                	<div id="secondary-emotions" class="grid grid-cols-2 gap-3">
                    	<!-- Secondary emotions will be added here -->
                	</div>
            	</div>
        	</div>
    	</div>
	</div>

	<script>
	// Global variables
let interviewInProgress = false;
let interviewId = null;
let questionNumber = 0;
let emotionData = [];
let currentEmotion = "Neutral";
let interviewStartTime = null;
let emotionChart = null;
let emotionHistoryChart = null;

// DOM Elements
const startBtn = document.getElementById('start-interview-btn');
const pauseBtn = document.getElementById('pause-interview-btn');
const endBtn = document.getElementById('end-interview-btn');
const nextBtn = document.getElementById('next-question-btn');
const saveAnswerBtn = document.getElementById('save-answer-btn');
const statusIndicator = document.getElementById('status-indicator');
const currentQuestion = document.getElementById('current-question');
const answerInput = document.getElementById('answer-input');
const questionCounter = document.getElementById('question-counter');
const questionProgress = document.getElementById('question-progress');
const overlayMessage = document.getElementById('overlay-message');
const recIndicator = document.getElementById('rec-indicator');
const recordingStatus = document.getElementById('recording-status');
const timelineDuration = document.getElementById('timeline-duration');
const useAI = document.getElementById('use-ai');

// Modal elements
const summaryModal = document.getElementById('summary-modal');
const closeModal = document.getElementById('close-modal');
const candidateModal = document.getElementById('candidate-modal');
const closeCandidateModal = document.getElementById('close-candidate-modal');
const emotionDetailsModal = document.getElementById('emotion-details-modal');
const closeEmotionDetails = document.getElementById('close-emotion-details');
const exportPdfBtn = document.getElementById('export-pdf-btn');
const saveNotesBtn = document.getElementById('save-notes-btn');
const toggleQA = document.getElementById('toggle-qa');

// Main functions
document.addEventListener('DOMContentLoaded', () => {
	// Initialize the UI
	initUI();
    
	// Event listeners
	startBtn.addEventListener('click', handleStartInterview);
	pauseBtn.addEventListener('click', handlePauseInterview);
	endBtn.addEventListener('click', handleEndInterview);
	nextBtn.addEventListener('click', handleNextQuestion);
	saveAnswerBtn.addEventListener('click', handleSaveAnswer);
    
	// Modal event listeners
	closeModal.addEventListener('click', () => { summaryModal.classList.add('hidden'); });
	closeCandidateModal.addEventListener('click', () => { candidateModal.classList.add('hidden'); });
	closeEmotionDetails.addEventListener('click', () => { emotionDetailsModal.classList.add('hidden'); });
	document.getElementById('view-emotion-details').addEventListener('click', showEmotionDetailsModal);
	document.getElementById('cancel-candidate-select').addEventListener('click', () => { candidateModal.classList.add('hidden'); });
	document.getElementById('load-candidate-btn').addEventListener('click', showCandidateModal);
	toggleQA.addEventListener('click', toggleQuestionAnswers);
	saveNotesBtn.addEventListener('click', saveInterviewNotes);
	exportPdfBtn.addEventListener('click', exportToPDF);
    
	// Get current state
	fetchCurrentState();
    
	// Start emotion polling
	startEmotionPolling();
});

function initUI() {
	// Initialize emotion badges
	updateEmotionBadges({ 'Happy': 0, 'Sad': 0, 'Angry': 0, 'Surprise': 0, 'Neutral': 100 });
    
	// Disable buttons initially
	nextBtn.disabled = true;
	saveAnswerBtn.disabled = true;
	endBtn.disabled = true;
    
	// Add fade-in animation to main content
	document.querySelector('.container').classList.add('fade-in');
    
	// Initialize emotion timeline
	initEmotionTimeline();
}

function fetchCurrentState() {
	fetch('/get_current_state')
    	.then(response => response.json())
    	.then(data => {
        	if (data.interview_in_progress) {
            	updateUIForActiveInterview(data);
        	}
    	})
    	.catch(error => console.error('Error fetching current state:', error));
}

function updateUIForActiveInterview(data) {
	interviewInProgress = true;
	startBtn.classList.add('hidden');
	pauseBtn.classList.remove('hidden');
	endBtn.disabled = false;
	nextBtn.disabled = false;
	saveAnswerBtn.disabled = false;
    
	// Update status indicator
	statusIndicator.innerHTML = '<i class="fas fa-circle text-xs mr-1"></i><span>ACTIVE</span>';
	statusIndicator.classList.remove('bg-yellow-500');
	statusIndicator.classList.add('bg-green-500');
    
	// Update recording indicator
	recIndicator.classList.add('recording-indicator');
	recordingStatus.textContent = 'Recording';
    
	// Update question and counter
	currentQuestion.textContent = data.question;
	questionNumber = data.question_number;
	questionCounter.textContent = questionNumber;
	updateQuestionProgress();
    
	// Update candidate info if available
	if (data.candidate) {
    	document.getElementById('candidate-name').value = data.candidate.name || '';
    	document.getElementById('candidate-email').value = data.candidate.email || '';
    	document.getElementById('candidate-position').value = data.candidate.position || 'general';
	}
}

function handleStartInterview() {
	const candidateName = document.getElementById('candidate-name').value;
	const candidateEmail = document.getElementById('candidate-email').value;
	const candidatePosition = document.getElementById('candidate-position').value;
    
	// Start interview API call
	fetch('/start_interview', {
    	method: 'POST',
    	headers: {
        	'Content-Type': 'application/json',
    	},
    	body: JSON.stringify({
        	name: candidateName,
        	email: candidateEmail,
        	role: candidatePosition
    	}),
	})
	.then(response => response.json())
	.then(data => {
    	if (data.status === 'started') {
        	interviewInProgress = true;
        	interviewId = data.interview_id;
        	questionNumber = data.question_number;
        	interviewStartTime = new Date();
       	 
        	// Update UI
        	startBtn.classList.add('hidden');
        	pauseBtn.classList.remove('hidden');
        	endBtn.disabled = false;
        	nextBtn.disabled = false;
        	saveAnswerBtn.disabled = false;
       	 
        	// Update status indicator
        	statusIndicator.innerHTML = '<i class="fas fa-circle text-xs mr-1"></i><span>ACTIVE</span>';
        	statusIndicator.classList.remove('bg-yellow-500');
        	statusIndicator.classList.add('bg-green-500');
       	 
        	// Update recording indicator
        	recIndicator.classList.add('recording-indicator');
        	recordingStatus.textContent = 'Recording';
       	 
        	// Update question
        	currentQuestion.textContent = data.question;
        	questionCounter.textContent = questionNumber;
        	updateQuestionProgress();
       	 
        	// Start emotion timeline
        	startEmotionTimeline();
    	}
	})
	.catch(error => console.error('Error starting interview:', error));
}

function handlePauseInterview() {
	if (interviewInProgress) {
    	// Toggle pause state
    	const isPaused = pauseBtn.innerHTML.includes('Resume');
   	 
    	if (isPaused) {
        	// Resume interview
        	pauseBtn.innerHTML = '<i class="fas fa-pause mr-2"></i> Pause';
        	overlayMessage.classList.add('hidden');
        	recIndicator.classList.add('recording-indicator');
        	recordingStatus.textContent = 'Recording';
    	} else {
        	// Pause interview
        	pauseBtn.innerHTML = '<i class="fas fa-play mr-2"></i> Resume';
        	overlayMessage.classList.remove('hidden');
        	recIndicator.classList.remove('recording-indicator');
        	recordingStatus.textContent = 'Paused';
    	}
	}
}

function handleEndInterview() {
	if (!interviewInProgress) return;
    
	// Get final answer
	const finalAnswer = answerInput.value;
    
	// End interview API call
	fetch('/end_interview', {
    	method: 'POST',
    	headers: {
        	'Content-Type': 'application/json',
    	},
    	body: JSON.stringify({
        	final_answer: finalAnswer,
        	role: document.getElementById('candidate-position').value
    	}),
	})
	.then(response => response.json())
	.then(data => {
    	if (data.status === 'ended') {
        	interviewInProgress = false;
       	 
        	// Update UI
        	pauseBtn.classList.add('hidden');
        	startBtn.classList.remove('hidden');
        	endBtn.disabled = true;
        	nextBtn.disabled = true;
        	saveAnswerBtn.disabled = true;
       	 
        	// Update status indicator
        	statusIndicator.innerHTML = '<i class="fas fa-circle text-xs mr-1"></i><span>READY</span>';
        	statusIndicator.classList.remove('bg-green-500');
        	statusIndicator.classList.add('bg-yellow-500');
       	 
        	// Stop recording indicator
        	recIndicator.classList.remove('recording-indicator');
        	recordingStatus.textContent = 'Ready';
       	 
        	// Reset UI
        	currentQuestion.textContent = 'Press Start Interview to begin';
        	answerInput.value = '';
       	 
        	// Show summary modal
        	showSummaryModal(data);
    	}
	})
	.catch(error => console.error('Error ending interview:', error));
}

function handleNextQuestion() {
	if (!interviewInProgress) return;
    
	// Get current answer
	const answer = answerInput.value;
    
	// Next question API call
	fetch('/next_question', {
    	method: 'POST',
    	headers: {
        	'Content-Type': 'application/json',
    	},
    	body: JSON.stringify({
        	answer: answer,
        	role: document.getElementById('candidate-position').value,
        	use_ai: useAI.checked
    	}),
	})
	.then(response => response.json())
	.then(data => {
    	if (data.status === 'success') {
        	// Update question
        	currentQuestion.textContent = data.question;
        	questionNumber = data.question_number;
        	questionCounter.textContent = questionNumber;
        	updateQuestionProgress();
       	 
        	// Clear answer field
        	answerInput.value = '';
       	 
        	// Reset AI checkbox
        	useAI.checked = false;
    	}
	})
	.catch(error => console.error('Error getting next question:', error));
}

function handleSaveAnswer() {
	if (!interviewInProgress) return;
    
	// Get current answer
	const answer = answerInput.value;
    
	// Save answer API call
	fetch('/save_answer', {
    	method: 'POST',
    	headers: {
        	'Content-Type': 'application/json',
    	},
    	body: JSON.stringify({
        	answer: answer,
        	question_number: questionNumber
    	}),
	})
	.then(response => response.json())
	.then(data => {
    	if (data.status === 'success') {
        	// Show confirmation
        	const saveBtn = document.getElementById('save-answer-btn');
        	saveBtn.innerHTML = '<i class="fas fa-check mr-1"></i> Saved';
        	setTimeout(() => {
            	saveBtn.innerHTML = '<i class="fas fa-save mr-1"></i> Save';
        	}, 2000);
    	}
	})
	.catch(error => console.error('Error saving answer:', error));
}

function updateQuestionProgress() {
	// Update progress bar (assuming 10 questions)
	const progress = (questionNumber / 10) * 100;
	questionProgress.style.width = `${Math.min(progress, 100)}%`;
}

// Emotion tracking functions
function startEmotionPolling() {
	// Poll for emotion updates every 2 seconds
	setInterval(() => {
    	if (interviewInProgress) {
        	fetch('/get_current_state')
            	.then(response => response.json())
            	.then(data => {
                	// Update emotion badges
                	updateCurrentEmotion(data.current_emotion);
            	})
            	.catch(error => console.error('Error polling emotions:', error));
    	}
	}, 2000);
}

function updateCurrentEmotion(emotion) {
	currentEmotion = emotion;
    
	// Remove active class from all badges
	document.querySelectorAll('.emotion-badge').forEach(badge => {
    	badge.classList.remove('active');
	});
    
	// Add active class to current emotion
	const emotionBadge = document.getElementById(`emotion-${emotion.toLowerCase()}`);
	if (emotionBadge) {
    	emotionBadge.classList.add('active');
	}
    
	// Generate random probabilities for visualization (this would be replaced with real data)
	const emotionProbs = {
    	'Happy': Math.random() * 0.3,
    	'Sad': Math.random() * 0.2,
    	'Angry': Math.random() * 0.15,
    	'Surprise': Math.random() * 0.25,
    	'Neutral': Math.random() * 0.4
	};
    
	// Ensure current emotion has highest probability
	let maxProb = 0;
	for (const [key, value] of Object.entries(emotionProbs)) {
    	if (value > maxProb) maxProb = value;
	}
	emotionProbs[emotion] = maxProb + 0.2;
    
	// Normalize probabilities
	const total = Object.values(emotionProbs).reduce((a, b) => a + b, 0);
	for (const key in emotionProbs) {
    	emotionProbs[key] = (emotionProbs[key] / total) * 100;
	}
    
	updateEmotionBadges(emotionProbs);
	updateEmotionTimeline(emotion);
}

function updateEmotionBadges(emotionProbs) {
	for (const [emotion, probability] of Object.entries(emotionProbs)) {
    	const badge = document.getElementById(`emotion-${emotion.toLowerCase()}`);
    	if (badge) {
        	const progressBar = badge.querySelector('.bg-gray-200 > div');
        	progressBar.style.width = `${probability}%`;
    	}
	}
}

// Timeline functions
function initEmotionTimeline() {
	const timeline = document.getElementById('emotion-timeline');
	timeline.innerHTML = '';
}

function startEmotionTimeline() {
	initEmotionTimeline();
	updateTimelineDuration(0);
}

function updateEmotionTimeline(emotion) {
	if (!interviewInProgress || !interviewStartTime) return;
    
	const timeline = document.getElementById('emotion-timeline');
	const elapsed = Math.floor((new Date() - interviewStartTime) / 1000);
    
	// Update duration display
	updateTimelineDuration(elapsed);
    
	// Add segment to timeline
	const segment = document.createElement('div');
	segment.className = 'emotion-timeline';
    
	// Set color based on emotion
	let color = '#6B7280'; // Default gray for neutral
	switch(emotion) {
    	case 'Happy':
        	color = '#10B981'; // Green
        	break;
    	case 'Sad':
        	color = '#3B82F6'; // Blue
        	break;
    	case 'Angry':
        	color = '#EF4444'; // Red
        	break;
    	case 'Surprise':
        	color = '#8B5CF6'; // Purple
        	break;
	}
    
	segment.style.backgroundColor = color;
	segment.style.width = '3px';
	segment.style.height = '100%';
	segment.title = `${emotion} at ${formatTime(elapsed)}`;
    
	timeline.appendChild(segment);
    
	// Store emotion data
	emotionData.push({
    	time: elapsed,
    	emotion: emotion
	});
}

function updateTimelineDuration(seconds) {
	const minutes = Math.floor(seconds / 60);
	const remainingSeconds = seconds % 60;
	timelineDuration.textContent = `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
}

function formatTime(seconds) {
	const minutes = Math.floor(seconds / 60);
	const remainingSeconds = seconds % 60;
	return `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
}

// Modal functions
function showSummaryModal(data) {
	// Set candidate info
	document.getElementById('summary-name').textContent = document.getElementById('candidate-name').value;
	document.getElementById('summary-position').textContent = document.getElementById('candidate-position').options[document.getElementById('candidate-position').selectedIndex].text;
	document.getElementById('summary-date').textContent = new Date().toLocaleDateString();
    
	// Set summary content
	document.getElementById('summary-content').innerHTML = data.summary;
    
	// Create emotion chart
	createEmotionChart(data.emotion_counts);
    
	// Populate Q&A section
	populateQASection(data.questions);
    
	// Show modal
	summaryModal.classList.remove('hidden');
}

function createEmotionChart(emotionCounts) {
	const ctx = document.getElementById('emotion-chart').getContext('2d');
    
	// Destroy existing chart if it exists
	if (emotionChart) emotionChart.destroy();
    
	// Prepare data
	const labels = Object.keys(emotionCounts);
	const data = Object.values(emotionCounts);
	const backgroundColors = labels.map(emotion => {
    	switch(emotion) {
        	case 'Happy': return '#10B981';
        	case 'Sad': return '#3B82F6';
        	case 'Angry': return '#EF4444';
        	case 'Surprise': return '#8B5CF6';
        	default: return '#6B7280';
    	}
	});
    
	// Create chart
	emotionChart = new Chart(ctx, {
    	type: 'pie',
    	data: {
        	labels: labels,
        	datasets: [{
            	data: data,
            	backgroundColor: backgroundColors,
            	borderWidth: 0
        	}]
    	},
    	options: {
        	responsive: true,
        	plugins: {
            	legend: {
                	position: 'right',
            	}
        	}
    	}
	});
}

function populateQASection(questions) {
	const qaContent = document.getElementById('qa-content');
	qaContent.innerHTML = '';
    
	questions.forEach((qa, index) => {
    	const qaItem = document.createElement('div');
    	qaItem.className = 'mb-3';
   	 
    	qaItem.innerHTML = `
        	<div class="font-medium text-blue-700">Q${index + 1}: ${qa.question}</div>
        	<div class="mt-1 text-gray-700">${qa.answer || 'No answer provided'}</div>
    	`;
   	 
    	qaContent.appendChild(qaItem);
	});
}

function toggleQuestionAnswers() {
	const qaContent = document.getElementById('qa-content');
	const toggleBtn = document.getElementById('toggle-qa');
    
	if (qaContent.classList.contains('max-h-60')) {
    	qaContent.classList.remove('max-h-60');
    	toggleBtn.innerHTML = '<i class="fas fa-chevron-up mr-1"></i> Show Less';
	} else {
    	qaContent.classList.add('max-h-60');
    	toggleBtn.innerHTML = '<i class="fas fa-chevron-down mr-1"></i> Show All';
	}
}

function showCandidateModal() {
	// Fetch candidates
	fetch('/get_candidates')
    	.then(response => response.json())
    	.then(data => {
        	populateCandidateList(data.candidates);
        	candidateModal.classList.remove('hidden');
    	})
    	.catch(error => console.error('Error fetching candidates:', error));
}

function populateCandidateList(candidates) {
	const candidateList = document.getElementById('candidate-list');
	candidateList.innerHTML = '';
    
	if (candidates.length === 0) {
    	candidateList.innerHTML = '<div class="p-3 text-center text-gray-500">No previous candidates found</div>';
    	return;
	}
    
	candidates.forEach(candidate => {
    	const item = document.createElement('div');
    	item.className = 'p-3 border-b border-gray-200 hover:bg-gray-50 cursor-pointer';
    	item.innerHTML = `
        	<div class="font-medium">${candidate.name}</div>
        	<div class="text-sm text-gray-500">${candidate.email}</div>
        	<div class="text-xs text-blue-500">${candidate.position}</div>
    	`;
   	 
    	item.addEventListener('click', () => {
        	selectCandidate(candidate);
    	});
   	 
    	candidateList.appendChild(item);
	});
    
	// Add search functionality
	const searchInput = document.getElementById('candidate-search');
	searchInput.addEventListener('input', (e) => {
    	const searchTerm = e.target.value.toLowerCase();
    	Array.from(candidateList.children).forEach(item => {
        	const candidateName = item.querySelector('.font-medium').textContent.toLowerCase();
        	const candidateEmail = item.querySelector('.text-sm').textContent.toLowerCase();
       	 
        	if (candidateName.includes(searchTerm) || candidateEmail.includes(searchTerm)) {
            	item.style.display = '';
        	} else {
            	item.style.display = 'none';
        	}
    	});
	});
}

function selectCandidate(candidate) {
	document.getElementById('candidate-name').value = candidate.name;
	document.getElementById('candidate-email').value = candidate.email;
	document.getElementById('candidate-position').value = candidate.position;
    
	candidateModal.classList.add('hidden');
}

function showEmotionDetailsModal() {
	// Set current emotion details
	document.getElementById('detail-primary-emotion').textContent = currentEmotion;
	document.getElementById('detail-confidence').textContent = `${Math.floor(Math.random() * 30 + 70)}%`; // Mock confidence value
    
	// Generate secondary emotions
	const secondaryEmotions = document.getElementById('secondary-emotions');
	secondaryEmotions.innerHTML = '';
    
	const emotions = ['Happy', 'Sad', 'Angry', 'Surprise', 'Neutral'].filter(e => e !== currentEmotion);
	emotions.forEach(emotion => {
    	const confidence = Math.floor(Math.random() * 30 + 10); // Random confidence between 10% and 40%
   	 
    	const emotionItem = document.createElement('div');
    	emotionItem.className = 'p-3 bg-gray-50 rounded-md';
    	emotionItem.innerHTML = `
        	<p class="text-sm font-medium text-gray-500">${emotion}</p>
        	<div class="flex items-center mt-1">
            	<div class="w-full bg-gray-200 rounded-full h-2 mr-2">
                	<div class="h-2 rounded-full" style="width: ${confidence}%; background-color:
                    	${emotion === 'Happy' ? '#10B981' :
                      	emotion === 'Sad' ? '#3B82F6' :
                      	emotion === 'Angry' ? '#EF4444' :
                      	emotion === 'Surprise' ? '#8B5CF6' : '#6B7280'}"></div>
            	</div>
            	<span class="text-xs">${confidence}%</span>
        	</div>
    	`;
   	 
    	secondaryEmotions.appendChild(emotionItem);
	});
    
	// Create emotion history chart
	createEmotionHistoryChart();
    
	// Show modal
	emotionDetailsModal.classList.remove('hidden');
}

function createEmotionHistoryChart() {
	const ctx = document.getElementById('emotion-history-chart').getContext('2d');
    
	// Destroy existing chart if it exists
	if (emotionHistoryChart) emotionHistoryChart.destroy();
    
	// Mock data - would be replaced with real emotion history
	const timeLabels = [];
	const happyData = [];
	const sadData = [];
	const angryData = [];
	const surpriseData = [];
	const neutralData = [];
    
	// Generate mock data points
	for (let i = 0; i < 20; i++) {
    	timeLabels.push(i);
    	happyData.push(Math.random() * 0.3);
    	sadData.push(Math.random() * 0.2);
    	angryData.push(Math.random() * 0.15);
    	surpriseData.push(Math.random() * 0.25);
    	neutralData.push(Math.random() * 0.4);
	}
    
	// Create chart
	emotionHistoryChart = new Chart(ctx, {
    	type: 'line',
    	data: {
        	labels: timeLabels,
        	datasets: [
            	{
                	label: 'Happy',
                	data: happyData,
                	borderColor: '#10B981',
                	backgroundColor: 'rgba(16, 185, 129, 0.1)',
                	tension: 0.4
            	},
            	{
                	label: 'Sad',
                	data: sadData,
                	borderColor: '#3B82F6',
                	backgroundColor: 'rgba(59, 130, 246, 0.1)',
                	tension: 0.4
            	},
            	{
                	label: 'Angry',
                	data: angryData,
                	borderColor: '#EF4444',
                	backgroundColor: 'rgba(239, 68, 68, 0.1)',
                	tension: 0.4
            	},
            	{
                	label: 'Surprise',
                	data: surpriseData,
                	borderColor: '#8B5CF6',
                	backgroundColor: 'rgba(139, 92, 246, 0.1)',
                	tension: 0.4
            	},
            	{
                	label: 'Neutral',
                	data: neutralData,
                	borderColor: '#6B7280',
                	backgroundColor: 'rgba(107, 114, 128, 0.1)',
                	tension: 0.4
            	}
        	]
    	},
    	options: {
        	responsive: true,
        	scales: {
            	y: {
                	beginAtZero: true,
                	max: 1
            	}
        	},
        	plugins: {
            	legend: {
                	position: 'top',
            	}
        	}
    	}
	});
}

function saveInterviewNotes() {
	const notes = document.getElementById('interview-notes').value;
    
	fetch('/save_notes', {
    	method: 'POST',
    	headers: {
        	'Content-Type': 'application/json',
    	},
    	body: JSON.stringify({
        	notes: notes,
        	interview_id: interviewId
    	}),
	})
	.then(response => response.json())
	.then(data => {
    	if (data.status === 'success') {
        	// Show confirmation
        	saveNotesBtn.innerHTML = '<i class="fas fa-check mr-2"></i> Notes Saved';
        	setTimeout(() => {
            	saveNotesBtn.innerHTML = '<i class="fas fa-save mr-2"></i> Save Notes';
        	}, 2000);
    	}
	})
	.catch(error => console.error('Error saving notes:', error));
}

function exportToPDF() {
	// Show loading state
	exportPdfBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Generating...';
    
	// Mock export functionality - would be replaced with actual PDF generation
	setTimeout(() => {
    	exportPdfBtn.innerHTML = '<i class="fas fa-check mr-2"></i> PDF Generated';
   	 
    	// Create mock download link
    	const link = document.createElement('a');
    	link.href = '#'; // Would be an actual file URL
    	link.download = `Interview_${interviewId}.pdf`;
    	link.click();
   	 
    	setTimeout(() => {
        	exportPdfBtn.innerHTML = '<i class="fas fa-file-pdf mr-2"></i> Export PDF';
    	}, 2000);
	}, 2000);
}
</script>
</body>
</html>
